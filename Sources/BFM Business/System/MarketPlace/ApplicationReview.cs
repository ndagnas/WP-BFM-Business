//*******************************************************************************************************************************
// DEBUT DU FICHIER
//*******************************************************************************************************************************

//*******************************************************************************************************************************
// Nom           : ApplicationReview.cs
// Auteur        : Nicolas Dagnas
// Description   : Déclaration de l'objet ApplicationReview
// Créé le       : 23/02/2015
// Modifié le    : 20/05/2015
//*******************************************************************************************************************************

//-------------------------------------------------------------------------------------------------------------------------------
#region Using directives
//-------------------------------------------------------------------------------------------------------------------------------
using System;
using System.Windows;
using System.IO.IsolatedStorage;
using System.Windows.Phone.Infos;
using System.Runtime.Serialization;
using System.Windows.Phone.Controls;
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
using Microsoft.Phone.Tasks;
//-------------------------------------------------------------------------------------------------------------------------------
#endregion
//-------------------------------------------------------------------------------------------------------------------------------

//*******************************************************************************************************************************
// Début du bloc "System.MarketPlace"
//*******************************************************************************************************************************
namespace System.MarketPlace
	{
	
	//   ###   ####   ####          ####   #####  #   #  #  #####  #   #
	//  #   #  #   #  #   #         #   #  #      #   #  #  #      #   #
	//  #####  ####   ####   #####  ####   ###    #   #  #  ###    #   #
	//  #   #  #      #             #   #  #       # #   #  #      # # #
	//  #   #  #      #             #   #  #####    #    #  #####   # # 

	//***************************************************************************************************************************
	// Classe ApplicationReview
	//***************************************************************************************************************************
	#region // Déclaration et Implémentation de l'Objet
	//---------------------------------------------------------------------------------------------------------------------------
	public static class ApplicationReview
		{
		//***********************************************************************************************************************
		#region // Structure ReviewItem
		//-----------------------------------------------------------------------------------------------------------------------
		[DataContract]
		public struct ReviewItem
			{
			//-------------------------------------------------------------------------------------------------------------------
			[DataMember]
			public int      StartUp         { get; set; }
			[DataMember]
			public bool     UserChoice      { get; set; }
			[DataMember]
			public int      RequestCount    { get; set; }
			[DataMember]
			public DateTime LastCheckDate   { get; set; }
			[DataMember]
			public DateTime LastRequestDate { get; set; }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			public override string ToString ()
				{
				//---------------------------------------------------------------------------------------------------------------
				string F1 = this.LastRequestDate.ToString ( "yyyyMMdd" );
				string F2 = ( this.UserChoice ) ? "T" : "F";

				return string.Format ( "{0}{1}{2}", F1, F2, this.RequestCount );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		// Section des Attributs
		//-----------------------------------------------------------------------------------------------------------------------
		private static bool Initialized = false;
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		#region // Section des Procédures Privées
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		/// <summary>
		/// 
		/// </summary>
		/// <param name="Choice"></param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void RegisterReview ( bool Choice )
			{
			//-------------------------------------------------------------------------------------------------------------------
			ReviewItem Review = new ReviewItem ()
				{
				//---------------------------------------------------------------------------------------------------------------
				StartUp         = 0             ,
				UserChoice      = Choice        ,
				RequestCount    = 0             ,
				LastCheckDate   = DateTime.Today,
				LastRequestDate = DateTime.Today,
				//---------------------------------------------------------------------------------------------------------------
				};
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( IsolatedStorageSettings.ApplicationSettings.Contains ( "review" ) )
					{
					//-----------------------------------------------------------------------------------------------------------
					Review = (ReviewItem)IsolatedStorageSettings.ApplicationSettings ["review"];

					Review.RequestCount   ++;
					Review.UserChoice      = Choice;
					Review.LastRequestDate = DateTime.Now;
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				IsolatedStorageSettings.ApplicationSettings ["review"] = Review;

				IsolatedStorageSettings.ApplicationSettings.Save ();
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Propose à l'utilisateur de mettre à jour son app.
		/// </summary>
		/// <param name="AppGuid">Identifiant de l'application.</param>
		/// <param name="Title">Titre de l'app.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		public static void SuggestReview ( string AppGuid, string Title )
			{
			//-------------------------------------------------------------------------------------------------------------------
			SuggestReview ( new Guid ( AppGuid ), Title );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Propose à l'utilisateur de mettre à jour son app.
		/// </summary>
		/// <param name="AppGuid">Identifiant de l'application.</param>
		/// <param name="Title">Titre de l'app.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		public static void SuggestReview ( Guid AppGuid, string Title )
			{
			//-------------------------------------------------------------------------------------------------------------------
			string Caption         = "Votre avis sur {0}";
			string Message         = "Vous appréciez utiliser {0} ?" + 
				                     "\n"                            + 
				                     "Prenez une seconde pour l'évaluer. Merci :)";
			string LeftButtonText  = "oui";
			string RightButtonText = "non";
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			if ( DeviceInfos.ApplicationCulture.TwoLetterISOLanguageName.EqualsIgnoreCase ("en") )
				{
				//---------------------------------------------------------------------------------------------------------------
				Caption         = "Review on {0}";
				Message         = "You appreciate use {0} ?" + 
				                  "\n"                       + 
				                  "Take a second to evaluate it. Thanks :)";
				LeftButtonText  = "yes";
				RightButtonText = "no";
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			Caption = string.Format ( Caption, Title );
			Message = string.Format ( Message, Title );
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			CustomMessageBox MessageBox = new CustomMessageBox ()
				{
				Caption            = Caption        ,
				Message            = Message        ,
				LeftButtonContent  = LeftButtonText ,
				RightButtonContent = RightButtonText,
				};
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			MessageBox.Dismissed += (S, A) =>
				{
				//---------------------------------------------------------------------------------------------------------------
				try
					{
					//-----------------------------------------------------------------------------------------------------------
					if ( A.Result == CustomMessageBoxResult.LeftButton )
						{
						ApplicationReview.RegisterReview ( true );

						(new MarketplaceReviewTask ()).Show ();
						}
					//-----------------------------------------------------------------------------------------------------------
					else { ApplicationReview.RegisterReview ( false ); }
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				catch {}
				//---------------------------------------------------------------------------------------------------------------
				};
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			MessageBox.Show ();
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		/// <summary>
		/// Affiche la fenêtre d'évaluation.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static void Show ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				ApplicationReview.RegisterReview ( true );

				(new MarketplaceReviewTask ()).Show ();
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Demande si la demande d'évaluation est faisable.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static bool IsAvailable
			{
			//-------------------------------------------------------------------------------------------------------------------
			get
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( ApplicationReview.Initialized ) return false;

				ApplicationReview.Initialized = true;
				//---------------------------------------------------------------------------------------------------------------
				
				//---------------------------------------------------------------------------------------------------------------
				ReviewItem Review = new ReviewItem ()
					{
					StartUp         = 0                ,
					UserChoice      = false            ,
					RequestCount    = 0                ,
					LastCheckDate   = DateTime.MinValue,
					LastRequestDate = DateTime.MinValue,
					};
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				try
					{
					//-----------------------------------------------------------------------------------------------------------
					if ( IsolatedStorageSettings.ApplicationSettings.Contains ( "review" ) )
						Review = (ReviewItem)IsolatedStorageSettings.ApplicationSettings["review"];
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					if ( Review.UserChoice                                     ) return false;
					if ( Review.StartUp         <  5                           ) return false;
					if ( Review.RequestCount    >= 3                           ) return false;
					if ( Review.LastCheckDate  .Date.Equals ( DateTime.Today ) ) return false;
					if ( Review.LastRequestDate.Date.Equals ( DateTime.Today ) ) return false;

					return ( DateTime.Now.Subtract ( Review.LastRequestDate ).TotalDays >= 30 );
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				catch {}
				//---------------------------------------------------------------------------------------------------------------
				finally
					{
					//-----------------------------------------------------------------------------------------------------------
					try
						{
						//-------------------------------------------------------------------------------------------------------
						if ( ! Review.UserChoice )
							{
							//---------------------------------------------------------------------------------------------------
							if ( ! Review.LastCheckDate.Date.Equals ( DateTime.Today ) )
								Review.StartUp ++;

							Review.LastCheckDate = DateTime.Today;

							IsolatedStorageSettings.ApplicationSettings ["review"] = Review;

							IsolatedStorageSettings.ApplicationSettings.Save ();
							//---------------------------------------------------------------------------------------------------
							}
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					catch {}
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				return false;
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		}
	//---------------------------------------------------------------------------------------------------------------------------
	#endregion
	//***************************************************************************************************************************
	
	} // Fin du namespace "System.MarketPlace"
//*******************************************************************************************************************************

//*******************************************************************************************************************************
// FIN DU FICHIER
//*******************************************************************************************************************************
